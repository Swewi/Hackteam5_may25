{% extends 'base.html' %}
{% load static %}
{% block title %}Assistant{% endblock %}
{% block content %}
<style>
    .interaction {
        /* display: flex;
        flex-direction: column;
        align-items: center;
        margin: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px; */
        display:block;
        text-align: left;
        margin: 10px;
        padding: 10px;
    }

    .user-question {
        font-weight: bold;
        color: #0c1d2f;
        background-color: #e6f0ff;
        position: relative;
        border: 2px solid #0c1d2f;
        border-radius: 20px;
        padding: 16px 24px;
        margin: 16px 0 24px 0;
    }

    .user-question::after {
        content: '';
        position: absolute;
        top: -20px;
        left: 15px;
        width: 0;
        height: 0;
        border: 12px solid transparent;
        border-bottom: 16px solid #0c1d2f;
        border-top: 0;
        border-radius: 4px;
    }

    .gemini-response {
        background-color: #e6f0ff;
        font-style: italic;
        font-weight: bold;
        color: #11441d;        
        /* Ensures the image covers the whole div */
        background-repeat: no-repeat;
        /* Prevents tiling */
        background-position: center;
        /* Centers the image */
        position: relative;
        border: 2px solid #11441d;
        border-radius: 20px;
        padding: 16px 24px;
        margin: 16px 0 24px 0;
    }

    .gemini-response::after {
        content: '';
        position: absolute;
        top: -20px;
        left: 15px;
        width: 0;
        height: 0;
        border: 12px solid transparent;
        border-bottom: 16px solid #11441d;
        border-top: 0;
        border-radius: 4px;
    }

    .you-label {
        font-weight: bold;
        color: #0c1d2f;  
        margin-left: 10px;    
    }

    .assistant-label {
        font-style: italic;
        font-weight: bold;
        color: #11441d;  
        margin-left: 10px;
    }

    #user-prompt {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
        margin-left: 20px;
        margin-right: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #save_conversation {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        background-color: #e6f0ff;
        height: 30px;
        width: 30px;  
        border: 2px solid #0c1d2f;
        border-radius: 5px;
        margin: 0;
        /* Remove vertical-align and let flexbox handle alignment */
    }
</style>

<h1 style="margin-top: 60px;">Welcome to the Assistant Page</h1>
<p>Ask a question to get help.</p>
{% for interaction in history %}
<div class="interaction" >
    <div class="you-label">You</div>
    <div class="user-question">{{ interaction.question }}</div>
    <div class="assistant-label">Assistant</div>
    <div class="gemini-response">{{ interaction.answer|linebreaksbr }}</div>
    <small>{{ interaction.timestamp }}</small>
</div>
{% empty %}
<p>No previous interactions.</p>
{% endfor %}
>
<div id="user-prompt">
    <input type="text" id="user_input" placeholder="Ask Assistant a question..." style="min-width: 85%;">
    <button id="send_button"><i class="fa fa-paper-plane"></i></button>
    <span id="save_conversation"><i class="fas fa-save"></i></span>    
</div>

<div id="saveModal" class="modal"
    style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%;">
        <span style="font-size: 24px; font-weight: bold;">Save Conversation</span>
        <br>
        <span id="closeModal"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" style="width: 100%; margin-bottom: 10px;">
        <div id="validation-message" style="color: red; "></div>
        <div style="text-align: right;">
            <button type="button" id="cancelButton">Cancel</button>
            <button type="button" id="okButton">OK</button>
        </div>
    </div>
</div>

<script>
    const userInput = document.getElementById('user_input');
    const sendButton = document.getElementById('send_button');
    // const geminiResponse = document.getElementById('gemini_response');

    sendButton.addEventListener('click', () => {
        const question = userInput.value;
        // replace contents of user-prompt with a spinner icon
        const userPrompt = document.getElementById('user-prompt');
        userPrompt.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch('/assistant/', {  //  Use the correct URL for your view
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `question=${encodeURIComponent(question)}`
        })
            .then(response => response.json())
            .then(data => {
                // Refresh the page
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                geminiResponse.textContent = 'An error occurred.';
            });
    });

    userInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            sendButton.click();
        }
    });

    const saveButton = document.getElementById('save_conversation');
    const modal = document.getElementById('saveModal');
    const closeModal = document.getElementById('closeModal');
    const cancelButton = document.getElementById('cancelButton');
    const okButton = document.getElementById('okButton');

    saveButton.addEventListener('click', () => {
        modal.style.display = 'block';
    });

    closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    cancelButton.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    okButton.addEventListener('click', () => {
        const titleField = document.getElementById('title');
        const validationMessage = document.getElementById('validation-message');

        if (titleField.value.trim() === '') {
            validationMessage.innerHTML = 'Title cannot be empty!';
            return;
        }

        // Fetch request to save the conversation
        fetch('/assistant/save-conversation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `title=${encodeURIComponent(titleField.value)}`
        })
            .then(response => response.json())
            .then(data => {
                // If data contains status=='success', show success message
                if (data.status === 'success') {
                    showMessage('Conversation saved successfully!');
                } else {
                    alert('Failed to save conversation.');
                }
                modal.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the conversation.');
            });
    });

    // Clear validation message when user starts typing in the title input
    const titleInput = document.getElementById('title');
    const validationMessage = document.getElementById('validation-message');
    titleInput.addEventListener('keyup', function () {
        if (validationMessage.innerHTML !== '') {
            validationMessage.innerHTML = '';
        }
    });

    // Close the modal when clicking outside of it
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Function for inserting a div with a message at the top of the page
    // The div gets removed after 5 seconds
    function showMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '10px';
        messageDiv.style.left = '50%';
        messageDiv.style.transform = 'translateX(-50%)';
        messageDiv.style.backgroundColor = '#f0f0f0';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.zIndex = '1001';
        messageDiv.style.color = 'green';
        messageDiv.style.fontWeight = 'bold';
        messageDiv.style.border = '1px solid #ccc';
        messageDiv.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
        messageDiv.style.fontSize = '16px';
        messageDiv.style.transition = 'opacity 0.5s ease-in-out';
        document.body.appendChild(messageDiv);

        setTimeout(() => {
            document.body.removeChild(messageDiv);
        }, 5000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% csrf_token %}
{% endblock %}