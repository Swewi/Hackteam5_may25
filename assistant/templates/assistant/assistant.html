{% extends 'base.html' %}
{% block title %}Assistant{% endblock %}
{% block content %}
<div style="position: fixed; top: 66px; left: 0; width: 100%; background-color: #f8f9fa; padding: 10px; border-bottom: 1px solid #ccc; z-index: 1000;">
    <button id="save_conversation" style="float: right;">Save conversation</button>
</div>
<h1 style="margin-top: 60px;">Welcome to the Assistant Page</h1>
<p>Ask a question to get help.</p>
{% for interaction in history %}
<div class="interaction" style="text-align: center; margin: 10px; padding: 10px; border: 1px solid #ccc;">
    <p class="user-question">You: {{ interaction.question }}</p>
    <div class="gemini-response">AI Name: {{ interaction.answer|linebreaksbr }}</div>
    <small>{{ interaction.timestamp }}</small>
</div>
{% empty %}
<p>No previous interactions.</p>
{% endfor %}
<!-- <div id="gemini_response"></div> -->
<div id="user-prompt" style="text-align: center;">
    <input type="text" id="user_input" placeholder="Ask Gemini a question..." style="width: 80%;">
    <button id="send_button">Send</button>
</div>

<div id="saveModal" class="modal" style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%;">
        <span id="closeModal" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" style="width: 100%; margin-bottom: 10px;">
        <div id="validation-message" style="color: red; "></div>
        <div style="text-align: right;">
            <button type="button" id="cancelButton">Cancel</button>
            <button type="button" id="okButton">OK</button>
        </div>
    </div>
</div>

<script>
    const userInput = document.getElementById('user_input');
    const sendButton = document.getElementById('send_button');
    // const geminiResponse = document.getElementById('gemini_response');

    sendButton.addEventListener('click', () => {
        const question = userInput.value;
        // replace contents of user-prompt with a spinner icon
        const userPrompt = document.getElementById('user-prompt');
        userPrompt.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch('/assistant/', {  //  Use the correct URL for your view
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `question=${encodeURIComponent(question)}`
        })
            .then(response => response.json())
            .then(data => {
                // Refresh the page
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                geminiResponse.textContent = 'An error occurred.';
            });
    });

    userInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            sendButton.click();
        }
    });

    const saveButton = document.getElementById('save_conversation');
    const modal = document.getElementById('saveModal');
    const closeModal = document.getElementById('closeModal');
    const cancelButton = document.getElementById('cancelButton');
    const okButton = document.getElementById('okButton');

    saveButton.addEventListener('click', () => {
        modal.style.display = 'block';
    });

    closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    cancelButton.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    okButton.addEventListener('click', () => {
        const titleField = document.getElementById('title');
        const validationMessage = document.getElementById('validation-message');
        
        if (titleField.value.trim() === '') {
            validationMessage.innerHTML ='Title cannot be empty!';
            return;
        }

        // Fetch request to save the conversation
        fetch('/assistant/save-conversation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `title=${encodeURIComponent(titleField.value)}`
        })
        .then(response => response.json())
        .then(data => {
            // If data contains status=='success', show success message
            if (data.status === 'success') {
                showMessage('Conversation saved successfully!');
            } else {
                alert('Failed to save conversation.');
            }            
            modal.style.display = 'none';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the conversation.');
        });
    });

    // Clear validation message when user starts typing in the title input
    const titleInput = document.getElementById('title');
    const validationMessage = document.getElementById('validation-message');
    titleInput.addEventListener('keyup', function() {
        if (validationMessage.innerHTML !== '') {
            validationMessage.innerHTML = '';
        }
    });

    // Close the modal when clicking outside of it
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Function for inserting a div with a message at the top of the page
    // The div gets removed after 5 seconds
    function showMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '10px';
        messageDiv.style.left = '50%';
        messageDiv.style.transform = 'translateX(-50%)';
        messageDiv.style.backgroundColor = '#f0f0f0';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.zIndex = '1001';
        messageDiv.style.color = 'green';
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            document.body.removeChild(messageDiv);
        }, 5000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% csrf_token %}
{% endblock %}