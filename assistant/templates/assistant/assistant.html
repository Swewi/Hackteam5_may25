{% extends 'base.html' %}
{% load static %}
{% block title %}Assistant{% endblock %}
{% block content %}
<style>
    .interaction {
        /* display: flex;
        flex-direction: column;
        align-items: center;
        margin: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px; */
        display:block;
        text-align: left;
        margin: 10px;
        padding: 10px;
    }

    .user-question {
        font-weight: bold;
        color: #0c1d2f;
        background-color: #e6f0ff;
        position: relative;
        border: 2px solid #0c1d2f;
        border-radius: 20px;
        padding: 16px 24px;
        margin: 16px 0 24px 0;
    }

    .user-question::after {
        content: '';
        position: absolute;
        top: -20px;
        left: 15px;
        width: 0;
        height: 0;
        border: 12px solid transparent;
        border-bottom: 16px solid #0c1d2f;
        border-top: 0;
        border-radius: 4px;
    }

    .gemini-response {
        background-color: #e6f0ff;
        font-style: italic;
        font-weight: bold;
        color: #11441d;        
        /* Ensures the image covers the whole div */
        background-repeat: no-repeat;
        /* Prevents tiling */
        background-position: center;
        /* Centers the image */
        position: relative;
        border: 2px solid #11441d;
        border-radius: 20px;
        padding: 16px 24px;
        margin: 16px 0 24px 0;
    }

    .gemini-response::after {
        content: '';
        position: absolute;
        top: -20px;
        left: 15px;
        width: 0;
        height: 0;
        border: 12px solid transparent;
        border-bottom: 16px solid #11441d;
        border-top: 0;
        border-radius: 4px;
    }

    .you-label {
        font-weight: bold;
        color: #0c1d2f;  
        margin-left: 10px;    
    }

    .assistant-label {
        font-style: italic;
        font-weight: bold;
        color: #11441d;  
        margin-left: 10px;
    }

    #user-prompt {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
        margin-left: 20px;
        margin-right: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #save_conversation {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        background-color: #e6f0ff;
        height: 30px;
        width: 30px;  
        border: 2px solid #0c1d2f;
        border-radius: 5px;
        margin: 0;
        /* Remove vertical-align and let flexbox handle alignment */
    }
</style>

<h1 style="margin-top: 60px;">Welcome to the Assistant Page</h1>
<p>Ask a question to get help.</p>
{% for interaction in history %}
<div class="interaction">
    <div class="you-label">You</div>
    <div class="user-question">{{ interaction.question }}</div>
    <div class="assistant-label">Assistant</div>
    <div class="gemini-response">{{ interaction.answer|linebreaksbr }}</div>
    <small class="text-muted">{{ interaction.timestamp }}</small>
</div>
{% empty %}
<p>No previous interactions.</p>
{% endfor %}
<div id="user-prompt">
    <input type="text" id="user_input" placeholder="Ask Assistant a question..." style="min-width: 85%;">
    <button id="send_button"><i class="fa fa-paper-plane"></i></button>
    <span id="save_conversation"><i class="fas fa-save"></i></span>    
</div>

<div id="saveModal" class="modal"
    style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%;">
        <span style="font-size: 24px; font-weight: bold;">Save Conversation</span>
        <br>
        <span id="closeModal"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" style="width: 100%; margin-bottom: 10px;">
        <div id="validation-message" style="color: red; "></div>
        <div style="text-align: right;">
            <button type="button" id="cancelButton">Cancel</button>
            <button type="button" id="okButton">OK</button>
        </div>
    </div>
</div>
<script>
    const userInput = document.getElementById('user_input');
    const sendButton = document.getElementById('send_button');

    sendButton.addEventListener('click', () => {
        const question = userInput.value;
        if (!question.trim()) {
            alert('Please enter a question');
            return;
        }
        
        // replace contents of user-prompt with a spinner icon
        const userPrompt = document.getElementById('user-prompt');
        const originalPromptHTML = userPrompt.innerHTML;
        userPrompt.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        fetch('/assistant/', {  //  Use the correct URL for your view
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `question=${encodeURIComponent(question)}`
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Refresh the page
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing your question.');
                // Restore the original input prompt
                userPrompt.innerHTML = originalPromptHTML;
            });
    });

    userInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            sendButton.click();
        }
    });

    const saveButton = document.getElementById('save_conversation');
    const modal = document.getElementById('saveModal');
    const closeModal = document.getElementById('closeModal');
    const cancelButton = document.getElementById('cancelButton');
    const okButton = document.getElementById('okButton');
    
    // Initialize Bootstrap modal
    const saveModalElement = new bootstrap.Modal(modal);

    saveButton.addEventListener('click', () => {
        // Clear any previous validation messages
        document.getElementById('validation-message').innerHTML = '';
        // Clear the title field
        document.getElementById('title').value = '';
        // Show the modal
        saveModalElement.show();
    });

    closeModal.addEventListener('click', () => {
        saveModalElement.hide();
    });

    cancelButton.addEventListener('click', () => {
        saveModalElement.hide();
    });

    okButton.addEventListener('click', () => {
        const titleField = document.getElementById('title');
        const validationMessage = document.getElementById('validation-message');

        if (titleField.value.trim() === '') {
            validationMessage.innerHTML = 'Title cannot be empty!';
            return;
        }

        // Disable the OK button and show loading state
        okButton.disabled = true;
        const originalButtonText = okButton.innerHTML;
        okButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

        // Fetch request to save the conversation
        fetch('/assistant/save-conversation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `title=${encodeURIComponent(titleField.value)}`
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide the modal first
                saveModalElement.hide();
                
                // If data contains status=='success', show success message and redirect to notes page
                if (data.status === 'success') {
                    showMessage('Conversation saved successfully!');
                    
                    // Optional: Redirect to the notes page after a short delay
                    setTimeout(() => {
                        window.location.href = '/notes/';
                    }, 1500);
                } else {
                    alert('Failed to save conversation: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the conversation: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                okButton.disabled = false;
                okButton.innerHTML = originalButtonText;
            });
    });

    // Clear validation message when user starts typing in the title input
    const titleInput = document.getElementById('title');
    const validationMessage = document.getElementById('validation-message');
    titleInput.addEventListener('input', function () {
        if (validationMessage.innerHTML !== '') {
            validationMessage.innerHTML = '';
        }
    });

    // Function for inserting a div with a message at the top of the page
    // The div gets removed after 5 seconds
    function showMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.className = 'alert alert-success notification-message position-fixed top-0 start-50 translate-middle-x mt-4';
        messageDiv.style.zIndex = '9999';
        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.classList.add('fade-out');
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
            }, 500);
        }, 4500);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .notification-message {
        transition: opacity 0.5s ease-in-out;
    }
    .fade-out {
        opacity: 0;
    }
</style>
{% csrf_token %}
{% endblock %}
